#!/usr/bin/php
<?php

// because we're still in BETA!
error_reporting(E_ALL);

// use composer for auto-loading
if (file_exists(__DIR__.'/../vendor/autoload.php')) {
    require_once __DIR__.'/../vendor/autoload.php';
} elseif (file_exists(__DIR__.'/../../../autoload.php')) {
    require_once __DIR__.'/../../../autoload.php';
} else {
    die('Could not locate the vendor autoloader');
}

// get process and debug server
$debugger = Debug\Debugger::get();
$server = $debugger->getServer();

// stats
$lastTime = float_microtime();
$num = 1;
$contextTimeOut = 3;

// ui message
echo 'Listening for debug messages...' . PHP_EOL;

do {
    if ($packet = $server->receive()) {

        // calculate duration since last debug message
        $msDuration = number_format(float_microtime() - $lastTime, 6);

        if ($contextTimeOut < $msDuration) {
            echo str_cli_color(
                '--------------------------------------------------------------------------------',
                'light_grey'
            );
            echo PHP_EOL;
        }

        $packet = explode(':', $packet);
        $domain = array_shift($packet);
        $color = array_shift($packet);
        $meta = array_shift($packet);
        list($num, $parts) = explode('of', $meta);
        // var_dump($num, $parts);
        $message = implode(':', $packet);

        if ('1' === $num) {

            // debug domain
            echo str_cli_color($domain, $color);
            echo ' ';

            // duration
            echo str_cli_color('+' . $msDuration . 's', 'light_grey');
            echo ' ';
        }

        // message
        echo $message;

        if ($num === $parts) {
            echo PHP_EOL;
        }

        // store last time
        $lastTime = float_microtime();
    }
}

while ($packet);
